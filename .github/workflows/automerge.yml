name: Auto Merge on Green Checks with Label

on:
  pull_request:
    types:
      - labeled
  check_suite:
    types: [completed]
  status: {}

jobs:
  automerge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check workflows status
        uses: actions/github-script@v7
        id: check_status
        with:
          github-token: ${{ secrets.TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const sha = context.payload.pull_request.head.sha;
  
            const { data: statuses } = await github.request('GET /repos/:owner/:repo/commits/:sha/check-runs', {
              owner,
              repo,
              sha
            });
            
            const actionStatuses = statuses.check_runs.map(checkRun => ({
              name: checkRun.name,
              conclusion: checkRun.conclusion
            }));

            console.log('actionStatuses', actionStatuses);
            
            const currentActionName = 'automerge';
            
            const isAllChecksArePassed = statuses.check_runs
              .filter(checkRun => checkRun.name !== currentActionName)
              .every(checkRun => checkRun.conclusion === 'success');

            console.log('The returned status of the tests is : ', isAllChecksArePassed);
  
            return isAllChecksArePassed;

      - name: Get result of prev step
        run: echo "${{steps.check_status.outputs.result}}"

      - name: Check if automerge label is == true
        run: echo "${{contains(github.event.pull_request.labels.*.name, 'automerge') == true }}"

      - name: Check if result like label is == true
        run: echo "${{contains(steps.check_status.outputs.result, true) == true }}"

      - name: Set Author to Github Actions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const res = await github.rest.users.getAuthenticated();
            console.log('res', res);

      - name: Merge Pull Requests with automerge label
        uses: actions/github-script@v7
        if: ${{ (contains(steps.check_status.outputs.result, true)) && (contains(github.event.pull_request.labels.*.name, 'automerge')) }}
        with:
          github-token: ${{ secrets.PAT }}

          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const merge_method = 'rebase'; // Can be 'merge', 'squash' or 'rebase'  
            const actorName = 'desired-username'; // Change this to the desired username
            const authorName = 'Automerge GitHub Action';
            const authorEmail = 'actions@github.com';

            // Get the pull request details
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: number,
            });

            // Amend the commit author of the pull request branch
            await github.request('PATCH /repos/{owner}/{repo}/git/refs/{ref}', {
              owner,
              repo,
              ref: `heads/${pr.data.head.ref}`,
              sha: pr.data.head.sha,
              author: {
                name: authorName,
                email: authorEmail,
              },
            });

            // Merge the pull request using the desired username
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: number,
              merge_method: 'squash', // or 'merge', 'rebase'
              commit_title: 'Your merge commit title',
              commit_message: 'Your merge commit message',
              commit_author: {
                name: actorName,
                email: authorEmail,
              },
            });

            console.log('Pull request merged successfully.');
